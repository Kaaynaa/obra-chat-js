<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Artisan Dashboard - Obra</title>
  <link rel="stylesheet" href="/styles/dashboard.css" />
</head>
<body>
  <div class="dashboard">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Obra</h2>
        <div class="user-badge">Artisan</div>
      </div>
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-page="clients">
          <span class="icon">üë•</span>
          <span>Mes Clients</span>
        </a>
        <a href="#" class="nav-item" data-page="projects">
          <span class="icon">üìã</span>
          <span>Projets</span>
        </a>
        <a href="#" class="nav-item" data-page="profile">
          <span class="icon">üè¢</span>
          <span>Mon Entreprise</span>
        </a>
        <a href="#" class="nav-item" data-page="settings">
          <span class="icon">‚öôÔ∏è</span>
          <span>Param√®tres</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn-logout">
          <span class="icon">üö™</span>
          D√©connexion
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <header class="page-header">
        <div>
          <h1 id="pageTitle">Mes Clients</h1>
          <p id="pageSubtitle">G√©rez votre portefeuille clients</p>
        </div>
        <div class="header-actions">
          <button id="addClientBtn" class="btn btn-primary">
            <span>+</span> Ajouter un client
          </button>
        </div>
      </header>

      <!-- PAGE: CLIENTS -->
      <section id="clientsPage" class="page-section active">
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Rechercher un client..." />
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalClients">0</div>
            <div class="stat-label">Total Clients</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeClients">0</div>
            <div class="stat-label">Clients Actifs</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="prospectClients">0</div>
            <div class="stat-label">Prospects</div>
          </div>
        </div>

        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Email</th>
                <th>T√©l√©phone</th>
                <th>Ville</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="clientsTableBody">
              <tr>
                <td colspan="6" class="loading">Chargement...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- PAGE: PROJECTS -->
      <section id="projectsPage" class="page-section">
        <div class="search-bar">
          <input type="text" id="projectSearchInput" placeholder="Rechercher un projet..." />
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalProjects">0</div>
            <div class="stat-label">Total Projets</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="inProgressProjects">0</div>
            <div class="stat-label">En cours</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completedProjects">0</div>
            <div class="stat-label">Termin√©s</div>
          </div>
        </div>

        <button id="addProjectBtn" class="btn btn-primary" style="margin-bottom: 20px;">
          <span>+</span> Nouveau projet
        </button>

        <div id="projectsGrid" class="projects-grid">
          <div class="loading-card">Chargement des projets...</div>
        </div>
      </section>

      <!-- PAGE: PROFILE -->
      <section id="profilePage" class="page-section">
        <div class="profile-card">
          <h3>Informations de l'entreprise</h3>
          <form id="profileForm">
            <div class="form-row">
              <div class="form-group">
                <label>Nom de l'entreprise</label>
                <input type="text" id="profileCompany" required />
              </div>
              <div class="form-group">
                <label>Type d'activit√©</label>
                <select id="profileType">
                  <option value="">S√©lectionner...</option>
                  <option value="plombier">Plombier</option>
                  <option value="electricien">√âlectricien</option>
                  <option value="menuisier">Menuisier</option>
                  <option value="peintre">Peintre</option>
                  <option value="ma√ßon">Ma√ßon</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>SIRET</label>
                <input type="text" id="profileSiret" />
              </div>
              <div class="form-group">
                <label>T√©l√©phone</label>
                <input type="tel" id="profilePhone" />
              </div>
            </div>
            <div class="form-group">
              <label>Adresse</label>
              <input type="text" id="profileAddress" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Ville</label>
                <input type="text" id="profileCity" />
              </div>
              <div class="form-group">
                <label>Code postal</label>
                <input type="text" id="profilePostal" />
              </div>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="profileDescription" rows="4"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
          </form>
        </div>
      </section>

      <!-- PAGE: SETTINGS -->
      <section id="settingsPage" class="page-section">
        <div class="settings-card">
          <h3>Param√®tres du compte</h3>
          <p>G√©rez vos param√®tres ici.</p>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL: AJOUTER/MODIFIER CLIENT -->
  <div id="clientModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="clientModalTitle">Ajouter un client</h2>
        <span class="modal-close">&times;</span>
      </div>
      <form id="clientForm">
        <input type="hidden" id="clientId" />
        <div class="form-row">
          <div class="form-group">
            <label>Nom complet</label>
            <input type="text" id="clientName" required />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="clientEmail" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>T√©l√©phone</label>
            <input type="tel" id="clientPhone" />
          </div>
          <div class="form-group">
            <label>Entreprise</label>
            <input type="text" id="clientCompany" />
          </div>
        </div>
        <div class="form-group">
          <label>Adresse</label>
          <input type="text" id="clientAddress" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Ville</label>
            <input type="text" id="clientCity" />
          </div>
          <div class="form-group">
            <label>Code postal</label>
            <input type="text" id="clientPostal" />
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="clientNotes" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Statut</label>
          <select id="clientStatus">
            <option value="prospect">Prospect</option>
            <option value="active">Client actif</option>
            <option value="inactive">Inactif</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary modal-close">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: AJOUTER/MODIFIER PROJET -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="projectModalTitle">Nouveau projet</h2>
        <span class="modal-close">&times;</span>
      </div>
      <form id="projectForm">
        <input type="hidden" id="projectId" />
        <div class="form-group">
          <label>Client</label>
          <select id="projectClient" required>
            <option value="">S√©lectionner un client...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Titre du projet</label>
          <input type="text" id="projectTitle" required />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="projectDescription" rows="4"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Budget (‚Ç¨)</label>
            <input type="number" id="projectBudget" step="0.01" />
          </div>
          <div class="form-group">
            <label>Statut</label>
            <select id="projectStatus">
              <option value="draft">Brouillon</option>
              <option value="in_progress">En cours</option>
              <option value="completed">Termin√©</option>
              <option value="cancelled">Annul√©</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Date de d√©but</label>
            <input type="date" id="projectStartDate" />
          </div>
          <div class="form-group">
            <label>Date de fin</label>
            <input type="date" id="projectEndDate" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary modal-close">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabaseUrl = 'YOUR_SUPABASE_URL';
    const supabaseAnonKey = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    let currentUser = null;
    let currentArtisan = null;
    let clients = [];
    let projects = [];

    // V√©rifier l'authentification
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/auth.html';
        return;
      }

      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', session.user.id)
        .single();

      if (profile?.role !== 'artisan') {
        alert('Acc√®s non autoris√©');
        window.location.href = '/index.html';
        return;
      }

      currentUser = profile;

      const { data: artisan } = await supabase
        .from('artisans')
        .select('*')
        .eq('user_id', currentUser.id)
        .single();

      currentArtisan = artisan;
      loadClients();
      loadProjects();
      loadProfile();
    }

    // Charger les clients
    async function loadClients() {
      try {
        const { data, error } = await supabase
          .from('clients')
          .select('*')
          .eq('artisan_id', currentArtisan.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        clients = data || [];
        renderClients(clients);
        updateClientStats();
        populateClientSelect();
      } catch (error) {
        console.error('Erreur:', error);
      }
    }

    // Afficher les clients
    function renderClients(data) {
      const tbody = document.getElementById('clientsTableBody');
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">Aucun client trouv√©</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(client => `
        <tr>
          <td>
            <div class="user-cell">
              <div class="user-avatar">${(client.full_name || 'C')[0]}</div>
              <div>
                <div>${client.full_name}</div>
                ${client.company_name ? `<small style="color:#888;">${client.company_name}</small>` : ''}
              </div>
            </div>
          </td>
          <td>${client.email || '-'}</td>
          <td>${client.phone || '-'}</td>
          <td>${client.city || '-'}</td>
          <td>
            <span class="status-badge status-${client.status}">
              ${client.status === 'active' ? 'Actif' : client.status === 'prospect' ? 'Prospect' : 'Inactif'}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-edit" data-id="${client.id}">‚úèÔ∏è</button>
              <button class="btn-icon btn-delete" data-id="${client.id}">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `).join('');

      tbody.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => editClient(btn.dataset.id));
      });
      tbody.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => deleteClient(btn.dataset.id));
      });
    }

    // Stats clients
    function updateClientStats() {
      document.getElementById('totalClients').textContent = clients.length;
      document.getElementById('activeClients').textContent = clients.filter(c => c.status === 'active').length;
      document.getElementById('prospectClients').textContent = clients.filter(c => c.status === 'prospect').length;
    }

    // Modal clients
    const clientModal = document.getElementById('clientModal');
    document.getElementById('addClientBtn').addEventListener('click', () => {
      document.getElementById('clientModalTitle').textContent = 'Ajouter un client';
      document.getElementById('clientForm').reset();
      document.getElementById('clientId').value = '';
      clientModal.style.display = 'flex';
    });

    document.getElementById('clientForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const clientId = document.getElementById('clientId').value;

      const formData = {
        artisan_id: currentArtisan.id,
        full_name: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        phone: document.getElementById('clientPhone').value,
        company_name: document.getElementById('clientCompany').value,
        address: document.getElementById('clientAddress').value,
        city: document.getElementById('clientCity').value,
        postal_code: document.getElementById('clientPostal').value,
        notes: document.getElementById('clientNotes').value,
        status: document.getElementById('clientStatus').value
      };

      try {
        if (clientId) {
          const { error } = await supabase.from('clients').update(formData).eq('id', clientId);
          if (error) throw error;
        } else {
          const { error } = await supabase.from('clients').insert(formData);
          if (error) throw error;
        }

        clientModal.style.display = 'none';
        loadClients();
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    });

    function editClient(id) {
      const client = clients.find(c => c.id === id);
      if (!client) return;

      document.getElementById('clientModalTitle').textContent = 'Modifier le client';
      document.getElementById('clientId').value = client.id;
      document.getElementById('clientName').value = client.full_name || '';
      document.getElementById('clientEmail').value = client.email || '';
      document.getElementById('clientPhone').value = client.phone || '';
      document.getElementById('clientCompany').value = client.company_name || '';
      document.getElementById('clientAddress').value = client.address || '';
      document.getElementById('clientCity').value = client.city || '';
      document.getElementById('clientPostal').value = client.postal_code || '';
      document.getElementById('clientNotes').value = client.notes || '';
      document.getElementById('clientStatus').value = client.status || 'prospect';

      clientModal.style.display = 'flex';
    }

    async function deleteClient(id) {
      if (!confirm('Supprimer ce client ?')) return;
      try {
        const { error } = await supabase.from('clients').delete().eq('id', id);
        if (error) throw error;
        loadClients();
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    }

    // PROJETS
    async function loadProjects() {
      try {
        const { data, error } = await supabase
          .from('projects')
          .select(`
            *,
            client:client_id (full_name)
          `)
          .eq('artisan_id', currentArtisan.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        projects = data || [];
        renderProjects(projects);
        updateProjectStats();
      } catch (error) {
        console.error('Erreur:', error);
      }
    }

    function renderProjects(data) {
      const grid = document.getElementById('projectsGrid');
      if (!data || data.length === 0) {
        grid.innerHTML = '<div class="no-data">Aucun projet</div>';
        return;
      }

      grid.innerHTML = data.map(project => `
        <div class="project-card">
          <div class="project-header">
            <h3>${project.title}</h3>
            <span class="status-badge status-${project.status}">
              ${project.status === 'in_progress' ? 'En cours' : project.status === 'completed' ? 'Termin√©' : project.status === 'draft' ? 'Brouillon' : 'Annul√©'}
            </span>
          </div>
          <p>${project.description || 'Aucune description'}</p>
          <div class="project-meta">
            <div>üë§ ${project.client?.full_name || 'N/A'}</div>
            ${project.budget ? `<div>üí∞ ${project.budget}‚Ç¨</div>` : ''}
          </div>
          <div class="action-buttons">
            <button class="btn-icon btn-edit" data-id="${project.id}">‚úèÔ∏è</button>
            <button class="btn-icon btn-delete" data-id="${project.id}">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');

      grid.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => editProject(btn.dataset.id));
      });
      grid.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => deleteProject(btn.dataset.id));
      });
    }

    function updateProjectStats() {
      document.getElementById('totalProjects').textContent = projects.length;
      document.getElementById('inProgressProjects').textContent = projects.filter(p => p.status === 'in_progress').length;
      document.getElementById('completedProjects').textContent = projects.filter(p => p.status === 'completed').length;
    }

    function populateClientSelect() {
      const select = document.getElementById('projectClient');
      select.innerHTML = '<option value="">S√©lectionner un client...</option>' +
        clients.map(c => `<option value="${c.id}">${c.full_name}</option>`).join('');
    }

    const projectModal = document.getElementById('projectModal');
    document.getElementById('addProjectBtn').addEventListener('click', () => {
      document.getElementById('projectModalTitle').textContent = 'Nouveau projet';
      document.getElementById('projectForm').reset();
      document.getElementById('projectId').value = '';
      projectModal.style.display = 'flex';
    });

    document.getElementById('projectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const projectId = document.getElementById('projectId').value;

      const formData = {
        artisan_id: currentArtisan.id,
        client_id: document.getElementById('projectClient').value,
        title: document.getElementById('projectTitle').value,
        description: document.getElementById('projectDescription').value,
        budget: document.getElementById('projectBudget').value || null,
        status: document.getElementById('projectStatus').value,
        start_date: document.getElementById('projectStartDate').value || null,
        end_date: document.getElementById('projectEndDate').value || null
      };

      try {
        if (projectId) {
          const { error } = await supabase.from('projects').update(formData).eq('id', projectId);
          if (error) throw error;
        } else {
          const { error } = await supabase.from('projects').insert(formData);
          if (error) throw error;
        }

        projectModal.style.display = 'none';
        loadProjects();
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    });

    function editProject(id) {
      const project = projects.find(p => p.id === id);
      if (!project) return;

      document.getElementById('projectModalTitle').textContent = 'Modifier le projet';
      document.getElementById('projectId').value = project.id;
      document.getElementById('projectClient').value = project.client_id || '';
      document.getElementById('projectTitle').value = project.title || '';
      document.getElementById('projectDescription').value = project.description || '';
      document.getElementById('projectBudget').value = project.budget || '';
      document.getElementById('projectStatus').value = project.status || 'draft';
      document.getElementById('projectStartDate').value = project.start_date || '';
      document.getElementById('projectEndDate').value = project.end_date || '';

      projectModal.style.display = 'flex';
    }

    async function deleteProject(id) {
      if (!confirm('Supprimer ce projet ?')) return;
      try {
        const { error } = await supabase.from('projects').delete().eq('id', id);
        if (error) throw error;
        loadProjects();
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    }

    // PROFIL
    function loadProfile() {
      if (!currentArtisan) return;
      document.getElementById('profileCompany').value = currentArtisan.company_name || '';
      document.getElementById('profileType').value = currentArtisan.business_type || '';
      document.getElementById('profileSiret').value = currentArtisan.siret || '';
      document.getElementById('profilePhone').value = currentUser.phone || '';
      document.getElementById('profileAddress').value = currentArtisan.address || '';
      document.getElementById('profileCity').value = currentArtisan.city || '';
      document.getElementById('profilePostal').value = currentArtisan.postal_code || '';
      document.getElementById('profileDescription').value = currentArtisan.description || '';
    }

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        const { error } = await supabase
          .from('artisans')
          .update({
            company_name: document.getElementById('profileCompany').value,
            business_type: document.getElementById('profileType').value,
            siret: document.getElementById('profileSiret').value,
            address: document.getElementById('profileAddress').value,
            city: document.getElementById('profileCity').value,
            postal_code: document.getElementById('profilePostal').value,
            description: document.getElementById('profileDescription').value
          })
          .eq('id', currentArtisan.id);

        if (error) throw error;

        await supabase
          .from('profiles')
          .update({ phone: document.getElementById('profilePhone').value })
          .eq('id', currentUser.id);

        alert('Profil mis √† jour');
      } catch (error) {
        alert('Erreur: ' + error.message);
      }
    });

    // Recherche
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase();
      const filtered = clients.filter(c =>
        (c.full_name || '').toLowerCase().includes(search) ||
        (c.email || '').toLowerCase().includes(search) ||
        (c.city || '').toLowerCase().includes(search)
      );
      renderClients(filtered);
    });

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const page = item.dataset.page;

        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));

        item.classList.add('active');
        document.getElementById(page + 'Page').classList.add('active');

        const titles = {
          clients: ['Mes Clients', 'G√©rez votre portefeuille clients'],
          projects: ['Mes Projets', 'Suivez vos projets en cours'],
          profile: ['Mon Entreprise', 'Informations de votre entreprise'],
          settings: ['Param√®tres', 'Configurez votre compte']
        };

        document.getElementById('pageTitle').textContent = titles[page][0];
        document.getElementById('pageSubtitle').textContent = titles[page][1];
      });
    });

    // Fermer les modals
    document.querySelectorAll('.modal-close').forEach(close => {
      close.addEventListener('click', () => {
        close.closest('.modal').style.display = 'none';
      });
    });

    // D√©connexion
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/auth.html';
    });

    checkAuth();
  </script>
</body>
</html>
